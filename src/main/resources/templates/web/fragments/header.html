<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security5">
<head>
    <meta charset="utf-8">
    <title>Header</title>

    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/css/cart.css}"/>

    <style>
        /* chặn click khi aria-disabled */
        a[aria-disabled="true"] { pointer-events:none; opacity:.5; }
        .qty-row .qty-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #ddd;border-radius:6px;line-height:1}
        .qty-input{width:36px;text-align:center;border:none;background:transparent}
    </style>
</head>
<body>
<th:block th:fragment="header">

    <div class="backdrop"></div>
    <a class="backtop fas fa-arrow-up" href="#"></a>

    <!-- Header top -->
    <div class="header-top">
        <div class="container">
            <div class="row">
                <div class="col-md-12 col-lg-5">
                    <div class="header-top-welcome">
                        <p>Chào mừng bạn đến với trang web TMDT !</p>
                    </div>
                </div>
                <div class="col-md-5 col-lg-3">
                    <div class="header-top-select">
                        <div class="header-select">
                            <i class="icofont-world"></i>
                            <select class="select">
                                <option value="vietnam" selected>Việt Nam</option>
                            </select>
                        </div>
                        <div class="header-select">
                            <i class="icofont-money"></i>
                            <select class="select">
                                <option value="vnd" selected>vnđ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header main -->
    <header class="header-part">
        <div class="container">
            <div class="header-content">

                <div class="header-media-group">
                    <button class="header-user">
                        <img src="/images/user.png" alt="user"/>
                    </button>
                    <a th:href="@{/}">
                        <img src="/images/logo.png" alt="logo"/>
                    </a>
                    <button class="header-src"><i class="fas fa-search"></i></button>
                </div>

                <a th:href="@{/}" class="header-logo">
                    <img src="/images/logo.png" alt="logo"/>
                </a>

                <a href="javascript:void(0);" class="header-widget" title="Tên của bạn">
                    <img src="/images/user.png" alt="user"/>
                    <span>Hi! <strong><em>[[${displayName}]]</em></strong></span>
                </a>

                <!-- Search -->
                <form th:action="@{/searchProduct}" class="header-form">
                    <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm kiếm..." autocomplete="off"/>
                    <button><i class="fas fa-search"></i></button>
                </form>

                <!-- Right widgets -->
                <div class="header-widget-group">
                    <a th:href="@{/profile}" class="header-widget" title="Trang cá nhân" sec:authorize="isAuthenticated()">
                        <i class="fas fa-user"></i>
                    </a>

                    <a th:href="@{/favorite}" class="header-widget" title="Yêu thích">
                        <i class="fas fa-heart"></i>
                        <sup th:text="${(totalSave != null) ? totalSave : 0}" id="totalSave">0</sup>
                    </a>

                    <a sec:authorize="hasAnyRole('ADMIN','STAFF')" th:href="@{/admin/home}" class="header-widget" title="Trang quản lý">
                        <i class="fas fa-tools"></i>
                    </a>

                    <!-- Badge = số mặt hàng khác nhau -->
                    <button class="header-widget header-cart js-open-cart" title="Giỏ hàng" type="button">
                        <i class="fas fa-shopping-basket"></i>
                        <sup th:text="${(totalCartItems != null) ? totalCartItems : 0}" id="totalCartItems">0</sup>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navbar -->
    <nav class="navbar-part">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="navbar-content">
                        <ul class="navbar-list">
                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Trang chủ</a>
                                <ul class="dropdown-position-list">
                                    <li><a th:href="@{/}">Trang chủ</a></li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Giới thiệu</a>
                                <ul class="dropdown-position-list">
                                    <li><a th:href="@{/aboutUs}">Giới thiệu</a></li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Sản phẩm</a>
                                <ul class="dropdown-position-list">
                                    <li><a th:href="@{/products}">Tất cả sản phẩm</a></li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Thể loại</a>
                                <ul class="dropdown-position-list">
                                    <li th:each="item : ${categoryList}">
                                        <a th:href="@{/productByCategory(id=${item.categoryId})}"
                                           th:text="${item.categoryName}">Thể loại</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Nhà xuất bản</a>
                                <ul class="dropdown-position-list">
                                    <li th:each="pub : ${nxbList}">
                                        <a th:href="@{/productByPublisher(id=${pub.id})}"
                                           th:text="${pub.name}">NXB</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Liên hệ</a>
                                <ul class="dropdown-position-list">
                                    <li><a th:href="@{/contact}">Liên hệ</a></li>
                                </ul>
                            </li>

                            <li class="navbar-item dropdown">
                                <a class="navbar-link dropdown-arrow" href="javascript:void(0);">Tài khoản</a>
                                <ul class="dropdown-position-list">
                                    <th:block sec:authorize="isAnonymous()">
                                        <li><a th:href="@{/login}">Đăng nhập</a></li>
                                        <li><a th:href="@{/register}">Đăng ký</a></li>
                                        <li><a th:href="@{/forgotPassword}">Quên mật khẩu</a></li>
                                    </th:block>
                                    <th:block sec:authorize="isAuthenticated()">
                                        <li><a th:href="@{/profile}">Thông tin tài khoản</a></li>
                                        <li><a th:href="@{/profile/change-password}">Đổi Mật khẩu</a></li>
                                        <li><a th:href="@{/logout}">Đăng xuất</a></li>
                                    </th:block>
                                </ul>
                            </li>
                        </ul>

                        <div class="navbar-info-group">
                            <div class="navbar-info">
                                <i class="icofont-ui-touch-phone"></i>
                                <p><small>Số điện thoại</small><span>(+84) 338 515 037</span></p>
                            </div>
                            <div class="navbar-info">
                                <i class="icofont-ui-email"></i>
                                <p><small>email</small><span>ttthinh2904@gmail.com</span></p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mini Cart (MVC links) -->
    <aside class="cart-sidebar" id="miniCart">
        <div class="cart-header">
            <div class="cart-total">
                <i class="fas fa-shopping-basket"></i>
                <span> Tổng số lượng giỏ hàng (
                  <span id="miniCartCount" th:text="${(totalCartQtySum != null) ? totalCartQtySum : 0}">0</span>
                ) </span>
            </div>
            <button class="cart-close js-close-cart" type="button"><i class="icofont-close"></i></button>
        </div>

        <!-- Empty -->
        <div th:if="${(totalCartQtySum == null) or (totalCartQtySum == 0)}" class="text-center p-4">
            <h4 class="mt-5" style="color:#119744">Hiện tại bạn chưa có sản phẩm nào trong giỏ hàng!</h4>
            <h5 style="color:#119744">Hãy mua sắm đi nào!</h5>
            <a th:href="@{/products}" style="text-decoration:underline;">Click tại đây!</a>
        </div>

        <!-- Has items -->
        <th:block th:if="${(totalCartQtySum != null) and (totalCartQtySum > 0)}">
            <ul class="cart-list" id="miniCartList">
                <li class="cart-item cart-row"
                    th:each="item : ${(cartItems != null) ? cartItems : T(java.util.Collections).emptyList()}"
                    th:data-id="${item.product.productId}"
                    th:data-unitprice="${item.product.price - (item.product.price * item.product.discount/100)}">

                    <div class="cart-media">
                        <a th:href="@{/productDetail(id=${item.product.productId})}">
                            <img th:src="@{'/loadImage?imageName=' + ${item.product.productImage}}" alt="product"/>
                        </a>
                    </div>

                    <div class="cart-info-group">
                        <div class="cart-info">
                            <h6 class="mb-1">
                                <a th:href="@{/productDetail(id=${item.product.productId})}"
                                   th:text="${item.product.productName}">Tên sp</a>
                            </h6>
                            <div class="price-row">
                                Tạm tính:
                                <strong class="line-total"
                                        th:text="${#numbers.formatDecimal((item.product.price - (item.product.price * item.product.discount/100)) * item.quantity, 1, 'DEFAULT', 0, 'DEFAULT')} + ' đ'">0 đ</strong>
                            </div>
                        </div>

                        <div class="action-row"
                             th:with="q=${item.quantity}, rawMax=${item.product.quantity}, max=${rawMax == null ? 999999 : rawMax}">
                            <div class="qty-row" style="display:flex; gap:8px; align-items:center;">
                                <button type="button" class="qty-btn dec-btn">−</button>
                                <input class="qty-input" type="tel" th:value="${q}" readonly />
                                <button type="button" class="qty-btn inc-btn">+</button>
                            </div>

                            <div class="stock-row"
                                 th:with="left=${(item.product.quantity == null) ? null : (item.product.quantity - q)}">
                                <span th:if="${left == null}">Kho: cập nhật</span>
                                <span th:if="${left != null}">Còn: <span class="stock">[[${left < 0 ? 0 : left}]]</span></span>
                            </div>

                            <a class="rm-btn" title="Xoá" th:href="@{/remove/{id}(id=${item.product.productId})}">
                                <i class="icofont-trash"></i>
                            </a>
                        </div>
                    </div>
                </li>
            </ul>

            <div class="cart-footer">
                <div class="sum-row">Tổng cộng:
                    <strong id="miniCartTotal"
                            th:text="${#numbers.formatDecimal(totalPrice, 1, 'DEFAULT', 0, 'DEFAULT')} + ' đ'">0 đ</strong>
                </div>
                <form id="miniCartForm" th:action="@{/cart/updateForCheckout}" method="post">
                    <input type="hidden" name="cartJson" id="miniCartJson" />
                    <a href="#" class="cart-checkout-btn" id="miniCartCheckoutBtn">
                        <span class="checkout-label">Thanh Toán</span>
                    </a>
                </form>


            </div>
        </th:block>
    </aside>
    <script>
        (function(){
            const openBtn = document.querySelector('.js-open-cart');
            const closeBtn = document.querySelector('.js-close-cart');
            const sidebar = document.getElementById('miniCart');
            const backdrop = document.querySelector('.backdrop');
            function open(){ sidebar && sidebar.classList.add('active'); backdrop && backdrop.classList.add('active'); }
            function close(){ sidebar && sidebar.classList.remove('active'); backdrop && backdrop.classList.remove('active'); }
            openBtn && openBtn.addEventListener('click', open);
            closeBtn && closeBtn.addEventListener('click', close);
            backdrop && backdrop.addEventListener('click', close);

            // chặn click khi aria-disabled="true"
            document.addEventListener('click', function(e){
                const a = e.target.closest('a.qty-btn');
                if (a && a.getAttribute('aria-disabled') === 'true') {
                    e.preventDefault(); e.stopPropagation();
                }
            });
        })();
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const formatCurrency = num => new Intl.NumberFormat("vi-VN").format(Math.round(num)) + " đ";

            function updateRowTotal(row) {
                const input = row.querySelector(".qty-input");
                const qty = Math.max(1, parseInt(input.value) || 1);
                const price = parseFloat(row.dataset.unitprice || 0);
                row.querySelector(".line-total").textContent = formatCurrency(price * qty);
            }

            function updateCartTotal() {
                let total = 0;
                document.querySelectorAll("li.cart-row").forEach(row => {
                    const qty = parseInt(row.querySelector(".qty-input").value) || 1;
                    const price = parseFloat(row.dataset.unitprice || 0);
                    total += qty * price;
                });
                const el = document.getElementById("miniCartTotal");
                if(el) el.textContent = formatCurrency(total);
            }

            // tăng giảm
            document.querySelectorAll("li.cart-row").forEach(row => {
                const decBtn = row.querySelector(".dec-btn");
                const incBtn = row.querySelector(".inc-btn");
                const input = row.querySelector(".qty-input");
                const max = parseInt(input.getAttribute("max")) || 999999;
                const min = 1;

                decBtn && decBtn.addEventListener("click", () => {
                    let v = Math.max(min, (parseInt(input.value) || min) - 1);
                    input.value = v;
                    updateRowTotal(row);
                    updateCartTotal();
                });

                incBtn && incBtn.addEventListener("click", () => {
                    let v = Math.min(max, (parseInt(input.value) || min) + 1);
                    input.value = v;
                    updateRowTotal(row);
                    updateCartTotal();
                });
            });

            // nút checkout mini cart
            const miniCheckoutBtn = document.getElementById("miniCartCheckoutBtn");
            const miniForm = document.getElementById("miniCartForm");
            const miniCartJsonInput = document.getElementById("miniCartJson");

            miniCheckoutBtn.addEventListener("click", function(e){
                e.preventDefault();
                const cart = [];
                document.querySelectorAll("li.cart-row").forEach(row => {
                    cart.push({
                        productId: row.dataset.id,
                        qty: parseInt(row.querySelector(".qty-input").value) || 1
                    });
                });
                miniCartJsonInput.value = JSON.stringify(cart);
                miniForm.submit(); // chỉ update số lượng -> redirect về trang checkout
            });


            // init tổng mini cart
            updateCartTotal();
        });

    </script>
</th:block>
</body>
</html>
