<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="author" content="mironcoder" />
    <meta name="email" content="mironcoder@gmail.com" />
    <meta name="profile" content="https://themeforest.net/user/mironcoder" />
    <meta name="template" content="book" />
    <meta name="title" content="book - Ecommerce Book Store HTML Template" />
    <meta name="keywords" content="organic, food, shop, ecommerce, store, html, bootstrap, template, agriculture, vegetables, products, farm, grocery, natural, online"/>
    <title>Web bán sách giá rẻ</title>

    <link rel="icon" th:href="@{/images/favicon.png}" />
    <link rel="stylesheet" th:href="@{/fonts/flaticon/flaticon.css}" />
    <link rel="stylesheet" th:href="@{/fonts/icofont/icofont.min.css}" />
    <link rel="stylesheet" th:href="@{/fonts/fontawesome/fontawesome.min.css}" />
    <link rel="stylesheet" th:href="@{/vendor/venobox/venobox.min.css}" />
    <link rel="stylesheet" th:href="@{/vendor/slickslider/slick.min.css}" />
    <link rel="stylesheet" th:href="@{/vendor/niceselect/nice-select.min.css}" />
    <link rel="stylesheet" th:href="@{/vendor/bootstrap/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/checkout.css}" />

    <!-- Patch nhỏ: khoá click khi aria-disabled="true" -->
    <style>
        a[aria-disabled="true"] { pointer-events: none; opacity: .5; }
        .qty-row .btn{min-width:32px}
        .table-list img{max-width:72px;border:1px solid #eee;border-radius:8px;background:#fff}
    </style>
</head>
<body>

<header th:replace="~{/web/fragments/header :: header}"></header>

<section class="inner-section single-banner"
         th:style="|background: url(@{/images/single-banner.jpg}) no-repeat center|">
    <div class="container">
        <h2>Thông tin đơn hàng</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
        </ol>
    </div>
</section>

<section class="inner-section checkout-part">
    <div class="container">
        <div class="row">

            <div class="col-lg-12">
                <div class="account-card">
                    <div class="account-title"><h4>Đơn Đặt Hàng Của Bạn</h4></div>

                    <!-- Giỏ rỗng -->
                    <div class="text-center" th:unless="${totalCartQtySum!=0}">
                        <h3 style="color: #119744" class="mt-5">Hiện tại bạn chưa có sản phẩm nào trong giỏ hàng!</h3>
                        <h4 style="color: #119744">Hãy mua sắm đi nào!</h4>
                        <a th:href="@{/products}" style="text-decoration: underline;">Click tại đây!</a>
                    </div>

                    <div class="account-content">
                        <div class="table-scroll">
                            <table class="table-list" th:if="${totalCartQtySum!=0}">
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Sản phẩm</th>
                                    <th scope="col">Tên sản phẩm</th>
                                    <th scope="col">Đơn giá</th>
                                    <th scope="col">Thể loại</th>
                                    <th scope="col">Số lượng</th>
                                    <th scope="col">action</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="item,State : ${cartItems}">
                                    <td class="table-serial"><h6>[[${State.index + 1}]]</h6></td>

                                    <td class="table-image">
                                        <img th:src="@{'/loadImage?imageName='+${item.product.productImage}}" alt="product" />
                                    </td>

                                    <td class="table-name">
                                        <h6>
                                            <a th:href="@{/productDetail(id=${item.product.productId})}"
                                               th:text="${item.product.productName}">Tên sản phẩm</a>
                                        </h6>
                                    </td>

                                    <td class="table-price">
                                        <h6>
                                            [[${#numbers.formatDecimal(item.product.price - (item.product.price * item.product.discount/100), 1, 'DEFAULT', 0, 'DEFAULT')} +' đ']]
                                            <small>/kg</small>
                                        </h6>
                                    </td>

                                    <td class="table-brand">
                                        <h6>[[${item.product.category.categoryName}]]</h6>
                                    </td>

                                    <!-- PATCH: cụm số lượng với redirect='checkout' + aria-disabled + null-safe stock -->
                                    <td class="table-quantity">
                                        <div class="qty-row" style="display:flex; gap:8px; align-items:center;"
                                             th:with="
                                                q=${item.quantity},
                                                rawMax=${item.product.quantity},
                                                max=${rawMax == null ? 999999 : rawMax}
                                             ">
                                            <!-- Giảm -->
                                            <a class="btn btn-sm btn-outline-secondary"
                                               th:href="@{/cart/dec(productId=${item.product.productId}, redirect='checkout')}"
                                               th:attr="aria-disabled=${q <= 1}"
                                               title="Giảm">−</a>

                                            <span><strong>[[${q}]]</strong></span>

                                            <!-- Tăng -->
                                            <a class="btn btn-sm btn-outline-secondary"
                                               th:href="@{/cart/inc(productId=${item.product.productId}, redirect='checkout')}"
                                               th:attr="aria-disabled=${q >= max}"
                                               title="Tăng">+</a>
                                        </div>

                                        <div class="text-muted" style="font-size:12px;"
                                             th:with="left=${(item.product.quantity == null) ? null : (item.product.quantity - item.quantity)}">
                                            <span th:if="${left == null}">Kho: cập nhật</span>
                                            <span th:if="${left != null}">Còn: [[${left < 0 ? 0 : left}]]</span>
                                        </div>
                                    </td>

                                    <td class="table-action">
                                        <a class="view"
                                           th:href="@{/productDetail(id=${item.product.productId})}"
                                           title="Chi tiết sản phẩm">
                                            <i class="fas fa-eye"></i>
                                        </a>

                                        <a class="trash" href="javascript:void(0);" title="Xóa sản phẩm"
                                           th:data-id="${item.product.productId}"
                                           th:data-name="${item.product.productName}"
                                           onclick="showConfigModalDialog(this.getAttribute('data-id'), this.getAttribute('data-name'))">
                                            <i class="icofont-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <th:block th:if="${totalCartQtySum!=0}">
                            <div class="chekout-coupon">
                                <h4>Tổng tiền thanh toán</h4>
                            </div>
                            <div class="checkout-charge">
                                <ul>
                                    <li>
                                        <span>Tổng tiền thanh toán<small>(Incl. VAT)</small></span>
                                        <span>[[${#numbers.formatDecimal(totalPrice, 1, 'DEFAULT', 0, 'DEFAULT')}+ ' đ']]</span>
                                    </li>
                                </ul>
                            </div>
                        </th:block>
                    </div>
                </div>
            </div>

            <!-- Form đặt hàng -->
            <div class="col-lg-12" th:if="${totalCartQtySum!=0}">
                <div class="account-card mb-0">
                    <div class="account-title">
                        <h4>Thông tin nhận hàng</h4>
                    </div>
                    <div class="account-content">
                        <div class="row">
                            <!-- POST đúng /checkout (đã có handler) -->
                            <form class="user-form" th:action="@{/checkout}" th:object="${order}" method="post">
                                <div class="form-group">
                                    <input type="email" th:value="${user.email}"
                                           class="form-control" placeholder="Email" readonly="readonly"/>
                                </div>

                                <div class="form-group">
                                    <input type="text" th:value="${user.name}"
                                           class="form-control" placeholder="Họ tên" readonly="readonly"/>
                                </div>

                                <div class="form-group">
                                    <input type="text" th:field="*{address}"
                                           class="form-control" placeholder="Địa chỉ" required="required"/>
                                </div>

                                <div class="form-group">
                                    <input type="tel" th:field="*{phone}"
                                           class="form-control" placeholder="Số điện thoại" required="required"/>
                                </div>

                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Nội dung đơn hàng"/>
                                </div>

                                <div class="form-group">
                                    <div class="account-title"><h4>Chọn phương thức thanh toán</h4></div>
                                    <div class="radio">
                                        <label style="color:#119744">
                                            <input type="radio" value="cod" name="checkOut" checked>
                                            <strong><em>Ship COD ( Thanh toán khi nhận hàng )</em></strong>
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label style="color:#119744">
                                            <input type="radio" value="paypal" name="checkOut">
                                            <strong><em>Thanh Toán Với Paypal</em></strong>
                                        </label>
                                    </div>
                                </div>

                                <div class="checkout-proced">
                                    <button type="submit" class="btn btn-inline">Đặt hàng</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</section>

<script>
    function showConfigModalDialog(id, name) {
        $('#productName').text(name);
        $('#yesOption').attr('href', '/remove/'+id);
        $('#configmationId').modal('show');
    }

    // (Tùy chọn) chặn cố tình click nút đã disabled
    document.addEventListener('click', function(e){
        const a = e.target.closest('a.btn, a.qty-btn');
        if (a && a.getAttribute('aria-disabled') === 'true') {
            e.preventDefault(); e.stopPropagation();
        }
    });
</script>

<!-- Modal xác nhận xoá -->
<div class="modal" id="configmationId">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <button class="modal-close" data-bs-dismiss="modal"><i class="icofont-close"></i></button>
            <div class="modal-form">
                <h5 class="modal-title">Xác nhận</h5>
                <div class="modal-body">
                    <p>Bạn có muốn xoá sản phẩm " <span style="color: #119744" id="productName"></span> " ra khỏi giỏ hàng không ?</p>
                </div>
                <div class="modal-footer">
                    <a id="yesOption" type="button" class="btn btn-success">Có</a>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{/web/fragments/footer :: footer}"></footer>

<script th:src="@{/vendor/bootstrap/jquery-1.12.4.min.js}"></script>
<script th:src="@{/vendor/bootstrap/popper.min.js}"></script>
<script th:src="@{/vendor/bootstrap/bootstrap.min.js}"></script>
<script th:src="@{/vendor/countdown/countdown.min.js}"></script>
<script th:src="@{/vendor/niceselect/nice-select.min.js}"></script>
<script th:src="@{/vendor/slickslider/slick.min.js}"></script>
<script th:src="@{/vendor/venobox/venobox.min.js}"></script>
<script th:src="@{/js/nice-select.js}"></script>
<script th:src="@{/js/countdown.js}"></script>
<script th:src="@{/js/accordion.js}"></script>
<script th:src="@{/js/venobox.js}"></script>
<script th:src="@{/js/slick.js}"></script>
<script th:src="@{/js/main.js}"></script>
</body>
</html>
