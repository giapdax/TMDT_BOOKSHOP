<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Xác nhận đổi mật khẩu</title>

    <!-- Vendor CSS của bạn -->
    <link rel="icon" href="images/favicon.png"/>
    <link rel="stylesheet" href="fonts/icofont/icofont.min.css"/>
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css"/>
    <link rel="stylesheet" href="vendor/slickslider/slick.min.css"/>
    <link rel="stylesheet" href="vendor/niceselect/nice-select.min.css"/>
    <link rel="stylesheet" href="vendor/venobox/venobox.min.css"/>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/user-auth.css"/>

    <style>
        /* Card đẹp, cân giữa, đừng pad 200px nữa */
        .otp-card { border-radius: 18px; box-shadow: 0 12px 28px rgba(0,0,0,.06); }
        .otp-title h2 { font-weight: 800; color:#2d7a41; }
        .otp-title p { color:#6c757d; margin-bottom: 0; }

        /* Grid ô OTP */
        .otp-inputs { display: grid; grid-template-columns: repeat(6, 48px); gap: 10px; justify-content:center; margin: 12px 0 18px; }
        .otp-inputs input {
            width:48px; height:52px; text-align:center; font-size:22px; font-weight:700;
            border:1px solid #dce3ea; border-radius:12px; outline:none; transition: all .15s ease;
            background: #fff;
        }
        .otp-inputs input:focus { border-color:#4caf50; box-shadow: 0 0 0 3px rgba(76,175,80,.15); }

        /* Nút hành động */
        .btn-primaryx {
            background:#2eb872; border:none; color:#fff; font-weight:700; border-radius:12px; padding:10px 18px;
        }
        .btn-primaryx:hover { filter: brightness(0.95); }
        .btn-ghost {
            background:#f4f6f8; border:1px solid #dfe5eb; color:#2b2f33; font-weight:600; border-radius:12px; padding:10px 16px;
        }
        .btn-ghost[disabled] { opacity:.55; cursor:not-allowed; }

        /* Countdown viên thuốc */
        .count-pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#f1f5f9; font-size:13px; color:#46515f; }

        /* Hộp thông báo */
        .alert { border-radius:12px; }
    </style>
</head>
<body>
<section class="user-form-part">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8 col-xl-7">
                <div class="user-form-logo text-center mb-3">
                    <a th:href="@{/}"><img src="images/logo.png" alt="logo" style="height:46px"/></a>
                </div>

                <div class="user-form-card otp-card p-4 p-md-5">
                    <div class="otp-title text-center mb-3">
                        <h2>Xác Nhận Đổi Mật Khẩu!</h2>
                        <p>Bảo vệ tài khoản của bạn</p>
                    </div>

                    <div class="mb-3">
                        <div class="alert alert-success" role="alert" th:if="${message}" th:text="${message}"></div>
                        <div class="alert alert-danger" role="alert" th:if="${error}" th:text="${error}"></div>
                    </div>

                    <div class="row g-4 align-items-start">
                        <!-- Cột trái: ô nhập OTP -->
                        <div class="col-12 col-lg-7">
                            <form th:action="@{/confirmOtpForgotPassword}" method="post" class="user-form" id="otpSubmitForm">
                                <input type="hidden" name="email" th:value="${email}"/>

                                <label class="form-label fw-bold">Nhập mã OTP (6 số)</label>
                                <div class="otp-inputs" id="otpInputs">
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control"/>
                                </div>

                                <!-- ô otp thật để submit (ẩn) -->
                                <input type="hidden" name="otp" id="otpHidden"/>

                                <div class="d-grid d-sm-inline-block">
                                    <button type="submit" class="btn btn-primaryx">
                                        <i class="icofont-check-circled"></i> Xác nhận
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Cột phải: gửi lại OTP -->
                        <div class="col-12 col-lg-5 text-center text-lg-start">
                            <form th:action="@{/resendOtpForgotPassword}" method="post" class="user-form" id="resendForm">
                                <input type="hidden" name="email" th:value="${email}"/>
                                <div class="d-flex flex-column align-items-center gap-2">
                                    <button type="submit" id="resendBtn" class="btn btn-ghost w-100">
                                        <span class="fw-bold">GỬI LẠI OTP</span>
                                    </button>
                                    <span id="countdown" class="count-pill">Chờ 60s</span>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    Bạn chỉ có thể gửi lại sau 60 giây và tối đa 5 lần cho mỗi phiên.
                                </small>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="user-form-remind text-center">
                    <p>Bạn đã có tài khoản?
                        <a th:href="@{/login}">Đăng nhập tại đây</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Vendor JS của bạn -->
<script src="vendor/bootstrap/jquery-1.12.4.min.js"></script>
<script src="vendor/bootstrap/popper.min.js"></script>
<script src="vendor/bootstrap/bootstrap.min.js"></script>
<script src="vendor/niceselect/nice-select.min.js"></script>
<script src="vendor/slickslider/slick.min.js"></script>
<script src="vendor/venobox/venobox.min.js"></script>
<script src="js/main.js"></script>

<script>
    // ===== OTP 6 ô – auto jump / backspace / paste =====
    (function () {
        const grid = document.getElementById('otpInputs');
        const inputs = Array.from(grid.querySelectorAll('input'));
        const hidden = document.getElementById('otpHidden');

        inputs[0].focus();

        inputs.forEach((inp, idx) => {
            inp.addEventListener('input', e => {
                inp.value = inp.value.replace(/[^0-9]/g,'').slice(0,1);
                if (inp.value && idx < inputs.length - 1) inputs[idx+1].focus();
                syncHidden();
            });
            inp.addEventListener('keydown', e => {
                if (e.key === 'Backspace' && !inp.value && idx > 0) {
                    inputs[idx-1].focus(); inputs[idx-1].value=''; syncHidden();
                }
            });
            // paste 6 số vào 1 ô
            inp.addEventListener('paste', e => {
                e.preventDefault();
                const data = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
                for (let i=0; i<inputs.length; i++) inputs[i].value = data[i] || '';
                syncHidden();
                const nxt = data.length >= 6 ? inputs[5] : inputs[data.length] || inputs[5];
                nxt.focus();
            });
        });

        function syncHidden(){
            hidden.value = inputs.map(i => i.value || '').join('');
        }

        // Validate trước khi submit (đủ 6 số)
        document.getElementById('otpSubmitForm').addEventListener('submit', function(e){
            syncHidden();
            if (hidden.value.length !== 6) {
                e.preventDefault();
                inputs[0].focus();
                alert('Vui lòng nhập đủ 6 số OTP.');
            }
        });
    })();

    // ===== Countdown 60s cho nút GỬI LẠI OTP (frontend) =====
    (function(){
        const btn = document.getElementById('resendBtn');
        const cd  = document.getElementById('countdown');
        if (!btn || !cd) return;

        let t = 60;
        tick();
        function tick(){
            if (t>0){
                btn.setAttribute('disabled','disabled');
                cd.textContent = 'Chờ ' + t + 's';
                t--; setTimeout(tick, 1000);
            } else {
                btn.removeAttribute('disabled');
                cd.textContent = 'Bạn có thể gửi lại';
            }
        }
    })();
</script>
</body>
</html>
