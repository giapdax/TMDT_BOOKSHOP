<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8" />
    <title>BOOK_SHOP - Trang quản trị</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <link rel="icon" href="/assets/img/icon.ico" type="image/x-icon"/>

    <!-- Fonts and icons -->
    <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: {"families":["Lato:300,400,700,900"]},
            custom: {"families":["Flaticon","Font Awesome 5 Solid","Font Awesome 5 Regular","Font Awesome 5 Brands","simple-line-icons"], urls: ['/assets/css/fonts.min.css']},
            active: function(){ sessionStorage.fonts = true; }
        });
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/atlantis.min.css">
    <link rel="stylesheet" href="/assets/css/demo.css">
    <style>.thumb{max-height:120px;border:1px solid #eee;padding:4px;border-radius:6px;background:#fff}</style>
</head>
<body>
<div class="wrapper">
    <!-- Header -->
    <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
    <!-- Navbar -->
    <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

    <div class="main-panel">
        <div class="content">
            <div class="page-inner">
                <div class="page-header">
                    <h4 class="page-title">Quản lý sản phẩm</h4>
                    <ul class="breadcrumbs">
                        <li class="nav-home"><a href="#"><i class="flaticon-home"></i></a></li>
                        <li class="separator"><i class="flaticon-right-arrow"></i></li>
                        <li class="nav-item"><a th:href="@{/admin/home}">Trang chủ</a></li>
                        <li class="separator"><i class="flaticon-right-arrow"></i></li>
                        <li class="nav-item"><a href="javascript:void(0);">Chỉnh sửa sản phẩm</a></li>
                    </ul>
                </div>

                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header"><h4 class="card-title" style="text-decoration: underline;">Sửa sản phẩm</h4></div>

                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-8 offset-lg-2">
                                    <!-- NHỚ enctype -->
                                    <form th:action="@{/admin/editProduct/{id}(id=${product.productId})}"
                                          th:object="${product}" method="post" enctype="multipart/form-data">

                                        <div class="form-group">
                                            <label>ID</label>
                                            <input type="text" th:field="*{productId}" class="form-control" readonly>
                                        </div>

                                        <div class="form-group">
                                            <label>Tên sản phẩm <span style="color:red">*</span></label>
                                            <input type="text" th:field="*{productName}" class="form-control" required>
                                            <small class="text-danger" th:if="${#fields.hasErrors('productName')}" th:errors="*{productName}"></small>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Thể loại <span style="color:red">*</span></label>
                                                <select class="form-control" th:field="*{categoryId}" required>
                                                    <option value="">-- Chọn thể loại --</option>
                                                    <option th:each="c : ${categoryAllList}"
                                                            th:value="${c.categoryId}"
                                                            th:text="${c.categoryName}"></option>
                                                </select>
                                                <small class="text-danger" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}"></small>
                                            </div>

                                            <div class="form-group col-md-6">
                                                <label>Nhà xuất bản</label>
                                                <select class="form-control" th:field="*{nxbId}">
                                                    <option value="">-- Chọn NXB --</option>
                                                    <option th:each="pub : ${nxbAllList}"
                                                            th:value="${pub.id}"
                                                            th:text="${pub.name}"></option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Đơn giá</label>
                                                <input type="number" min="0" step="0.01" th:field="*{price}" class="form-control" required>
                                                <small class="text-danger" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></small>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>Số lượng</label>
                                                <input type="number" min="0" th:field="*{quantity}" class="form-control" required>
                                                <small class="text-danger" th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"></small>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>Giảm giá (%)</label>
                                                <input type="number" min="0" max="90" th:field="*{discount}" class="form-control">
                                                <small class="text-danger" th:if="${#fields.hasErrors('discount')}" th:errors="*{discount}"></small>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>Ngày thêm</label>
                                                <input type="date" th:field="*{enteredDate}" class="form-control" required>
                                                <small class="text-danger" th:if="${#fields.hasErrors('enteredDate')}" th:errors="*{enteredDate}"></small>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>Trạng thái hiển thị</label>
                                            <select class="form-control" th:field="*{status}">
                                                <option th:value="true">HIỂN THỊ</option>
                                                <option th:value="false">ẨN</option>
                                            </select>
                                            <small class="text-danger" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></small>
                                        </div>

                                        <div class="form-group">
                                            <label>Ảnh hiện tại / ảnh mới</label><br>
                                            <img class="thumb"
                                                 th:if="${product.productImage != null and !#strings.isEmpty(product.productImage)}"
                                                 th:src="@{'/loadImage?imageName=' + ${product.productImage}}"
                                                 alt="preview">
                                            <img class="thumb"
                                                 th:unless="${product.productImage != null and !#strings.isEmpty(product.productImage)}"
                                                 th:src="@{/images/no-image.png}" alt="no-image">

                                            <!-- giữ tên ảnh (kể cả __tmp__) nếu không upload mới -->
                                            <input type="hidden" th:field="*{productImage}">
                                        </div>

                                        <div class="form-group">
                                            <label>Ảnh mới (tùy chọn)</label>
                                            <input type="file" id="productImageFile" name="file" class="form-control" accept="image/*">
                                            <small class="text-danger" th:if="${#fields.hasErrors('productId')}" th:errors="*{productId}"></small>
                                        </div>

                                        <div class="form-group">
                                            <label>Mô tả sản phẩm</label>
                                            <textarea th:field="*{description}" class="form-control" rows="4"></textarea>
                                            <small class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></small>
                                        </div>

                                        <div class="text-right">
                                            <button type="submit" class="btn btn-primary">Cập nhật</button>
                                            <a th:href="@{/admin/products}" class="btn btn-danger">Hủy</a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <footer class="footer">
            <div class="container-fluid">
                <div class="copyright ml-auto">
                    2025, made with <i class="fa fa-heart heart text-danger"></i> by <a href="javascript:void(0);">BOOK-SHOP</a>
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Core JS -->
<script src="/assets/js/core/jquery.3.2.1.min.js"></script>
<script src="/assets/js/core/popper.min.js"></script>
<script src="/assets/js/core/bootstrap.min.js"></script>
<script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
<script src="/assets/js/atlantis.min.js"></script>
<script>
    // Preview ảnh mới (client-side); khi submit lỗi server, ảnh tạm (__tmp__) vẫn hiển thị từ server
    (function(){
        var file = document.getElementById('productImageFile');
        if(!file) return;
        file.addEventListener('change', function(){
            var f = this.files && this.files[0];
            if(!f) return;
            var r = new FileReader();
            r.onload = function(e){
                var img = document.querySelector('.thumb');
                if(img){ img.src = e.target.result; }
            };
            r.readAsDataURL(f);
        });
    })();
</script>
</body>
</html>
